<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vistoria - fotos com data/hora</title>
  <style>
    body{font-family:Arial, sans-serif;background:#111827;color:#fff;display:flex;align-items:center;justify-content:center;min-height:100vh;margin:0;padding:16px}
    .card{width:100%;max-width:720px;background:#0b1220;border-radius:12px;padding:16px;box-shadow:0 10px 30px rgba(2,6,23,.6);text-align:center}
    video, canvas{width:100%;height:auto;border-radius:8px;background:#000}
    button{background:#2b6cb0;border:0;padding:10px 12px;border-radius:8px;color:white;cursor:pointer;margin-top:8px}
    small{color:#9aa7b8;display:block;margin-top:8px}
  </style>
</head>
<body>
  <div class="card">
    <h1>Vistoria - Captura de Foto</h1>
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" style="display:none"></canvas>
    <button id="capture">üì∏ Capturar</button>
    <a id="download" style="display:none" download>‚¨áÔ∏è Baixar imagem</a>
    <small>Ao capturar, a data e hora ser√£o adicionadas automaticamente.</small>
  </div>

<script>
(async function(){
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const captureBtn = document.getElementById('capture');
  const downloadBtn = document.getElementById('download');
  let stream;

  function nowDatetime(){
    const d = new Date();
    const pad = n=>String(n).padStart(2,'0');
    return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  }

  async function startCamera(){
    if (stream) {
      stream.getTracks().forEach(t=>t.stop());
      stream = null;
    }
    const constraints = {
      video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } },
      audio: false
    };
    try{
      stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream;
      await video.play();
    }catch(err){
      alert('Erro ao acessar a c√¢mera: '+err.message);
      console.error(err);
    }
  }

  captureBtn.addEventListener('click', ()=>{
    const vw = video.videoWidth;
    const vh = video.videoHeight;
    canvas.width = vw;
    canvas.height = vh;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video,0,0,vw,vh);

    // Marca d'√°gua com data e hora no canto inferior esquerdo
    const fontSize = 32;
    ctx.font = `${fontSize}px sans-serif`;
    ctx.fillStyle = "black";
    ctx.textBaseline = 'bottom';
    const text = nowDatetime();
    const padding = 20;
    ctx.fillText(text, padding, vh - padding);

    // Criar download
    canvas.toBlob(function(blob){
      const url = URL.createObjectURL(blob);
      downloadBtn.href = url;
      downloadBtn.download = `vistoria_${Date.now()}.jpg`;
      downloadBtn.style.display = 'inline-block';
    }, 'image/jpeg', 0.9);
  });

  startCamera();
})();
</script>
</body>
</html>
