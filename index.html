<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vistoria PWA - Fotos Autom치ticas</title>
  <link rel="manifest" href="manifest.json">
  <style>
    body{font-family:Arial, sans-serif;background:#111827;color:#fff;display:flex;align-items:center;justify-content:center;min-height:100vh;margin:0;padding:16px}
    .card{width:100%;max-width:720px;background:#0b1220;border-radius:12px;padding:16px;box-shadow:0 10px 30px rgba(2,6,23,.6);text-align:center}
    video, canvas{width:100%;height:auto;border-radius:8px;background:#000}
    button{background:#2b6cb0;border:0;padding:10px 12px;border-radius:8px;color:white;cursor:pointer;margin-top:8px}
    small{color:#9aa7b8;display:block;margin-top:8px}
  </style>
</head>
<body>
  <div class="card">
    <h1>Vistoria - Captura Autom치tica</h1>
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" style="display:none"></canvas>
    <button id="capture">游닞 Capturar</button>
    <small>Ao capturar, a data/hora ser치 adicionada e a foto ser치 salva automaticamente na pasta escolhida.</small>
  </div>

<script>
(async function(){
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const captureBtn = document.getElementById('capture');
  let stream;
  let dirHandle;

  function nowDatetime(){
    const d = new Date();
    const pad = n=>String(n).padStart(2,'0');
    return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  }

  async function startCamera(){
    if (stream) stream.getTracks().forEach(t=>t.stop());
    try{
      stream = await navigator.mediaDevices.getUserMedia({video: {facingMode: 'environment'}, audio: false});
      video.srcObject = stream;
      await video.play();
    }catch(err){
      alert('Erro ao acessar a c칙mera: '+err.message);
    }
  }

  // Solicita ao usu치rio a pasta onde salvar as fotos (apenas uma vez)
  async function selectDirectory(){
    if ('showDirectoryPicker' in window){
      try{
        dirHandle = await window.showDirectoryPicker();
      }catch(err){
        alert('Necess치rio selecionar uma pasta para salvar as fotos.');
      }
    } else {
      alert('Seu navegador n칚o suporta File System Access API. Fotos ser칚o apenas baixadas manualmente.');
    }
  }

  captureBtn.addEventListener('click', async ()=>{
    if(!dirHandle){
      await selectDirectory();
      if(!dirHandle) return;
    }

    const vw = video.videoWidth;
    const vh = video.videoHeight;
    canvas.width = vw;
    canvas.height = vh;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video,0,0,vw,vh);

    const fontSize = 32;
    ctx.font = `${fontSize}px sans-serif`;
    ctx.fillStyle = "black";
    ctx.textBaseline = 'bottom';
    ctx.fillText(nowDatetime(), 20, vh - 20);

    canvas.toBlob(async function(blob){
      const fileName = `vistoria_${Date.now()}.jpg`;
      if(dirHandle){
        const fileHandle = await dirHandle.getFileHandle(fileName,{create:true});
        const writable = await fileHandle.createWritable();
        await writable.write(blob);
        await writable.close();
        alert(`Foto ${fileName} salva automaticamente na pasta escolhida!`);
      } else {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        a.click();
      }
    }, 'image/jpeg', 0.9);
  });

  startCamera();
})();
</script>
</body>
</html>
