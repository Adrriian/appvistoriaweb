<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Galeria de Fotos - Vistoria</title>
<style>
  body { font-family: Arial; padding: 20px; background: #f5f5f5; margin: 0; }
  h1 { text-align: center; margin-bottom: 20px; }
  #baixar-todas { display: block; margin: 0 auto 20px auto; padding: 12px 24px; font-size: 16px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; }
  #baixar-todas:hover { background: #218838; }
  #galeria { display: grid; grid-template-columns: repeat(3,1fr); gap:5px; justify-items:center; }
  #galeria img { width:200px; height:200px; object-fit:cover; border-radius:8px; }
  @media (max-width:800px){ #galeria{grid-template-columns:repeat(2,1fr);} }
  @media (max-width:500px){ #galeria{grid-template-columns:1fr;} }
</style>
</head>
<body>

<h1>Galeria de Fotos da Vistoria</h1>
<button id="baixar-todas">Baixar todas as fotos</button>
<div id="galeria"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<script>
const galeria = document.getElementById('galeria');
const btnDownload = document.getElementById('baixar-todas');

// URL da tabela do Neon
const NEON_API = "https://ep-jolly-wildflower-ac6kwkbd.apirest.sa-east-1.aws.neon.tech/neondb/rest/v1/fotos";
const NEON_KEY = "INSIRA_SUA_API_KEY_AQUI"; // coloque sua chave real

let fotos = [];
let registros = [];

// Função para carregar fotos
async function carregarFotos() {
  try {
    const res = await fetch(NEON_API, {
      method: 'GET',
      headers: {
        "apikey": NEON_KEY,
        "Authorization": `Bearer ${NEON_KEY}`,
        "Content-Type": "application/json"
      }
    });
    if(!res.ok) throw new Error(`${res.status} - ${res.statusText}`);

    registros = await res.json();

    fotos = registros
      .filter(r => r.base64) // pega apenas registros que têm imagem
      .map(r => ({
        id: r.id,
        nome: r.nome,
        mime: r.mime,
        data: r.base64
      }));

    fotos.forEach((f, i) => {
      const img = document.createElement('img');
      img.src = `data:${f.mime};base64,${f.data}`;
      img.alt = f.nome || `Foto ${i+1}`;
      galeria.appendChild(img);
    });

  } catch(err) {
    console.error("Erro ao carregar fotos:", err);
    alert("Erro ao carregar fotos. Confira o console.");
  }
}

// Função para baixar todas as fotos em ZIP
async function baixarTodasFotos() {
  if(fotos.length === 0){
    alert("Nenhuma foto para baixar.");
    return;
  }

  const zip = new JSZip();
  fotos.forEach((f, i) => {
    const byteCharacters = atob(f.data);
    const byteNumbers = new Array(byteCharacters.length);
    for (let j = 0; j < byteCharacters.length; j++) {
      byteNumbers[j] = byteCharacters.charCodeAt(j);
    }
    const byteArray = new Uint8Array(byteNumbers);
    zip.file(`${f.nome || 'foto_'+(i+1)}.jpg`, byteArray);
  });

  const content = await zip.generateAsync({type:'blob'});
  saveAs(content, 'vistoria.zip');

  // Após baixar, apagar os registros do Neon
  await apagarRegistros();
}

// Função para apagar registros do Neon
async function apagarRegistros() {
  try {
    for(const r of registros){
      await fetch(`${NEON_API}?id=eq.${r.id}`, {
        method: 'DELETE',
        headers: {
          "apikey": NEON_KEY,
          "Authorization": `Bearer ${NEON_KEY}`,
          "Content-Type": "application/json"
        }
      });
    }
    galeria.innerHTML = '';
    fotos = [];
    alert("Fotos baixadas e registros apagados do Neon!");
  } catch(err) {
    console.error("Erro ao apagar registros:", err);
    alert("Erro ao apagar registros. Confira o console.");
  }
}

btnDownload.addEventListener('click', baixarTodasFotos);

// Carregar fotos ao abrir a página
carregarFotos();

</script>
</body>
</html>
